controller:
  watchIngressWithoutClass: true
  kind: DaemonSet
  hostNetwork: true

  service:
    type: LoadBalancer
    annotations:
      load-balancer.hetzner.cloud/name: ingress-nginx-lb
      load-balancer.hetzner.cloud/use-private-ip: "true"
      load-balancer.hetzner.cloud/protocol: tcp
      load-balancer.hetzner.cloud/algorithm-type: round_robin
      load-balancer.hetzner.cloud/type: lb11
      load-balancer.hetzner.cloud/location: fsn1
      load-balancer.hetzner.cloud/private-ipv4: 10.0.1.2
      load-balancer.hetzner.cloud/uses-proxyprotocol: "true"
    externalTrafficPolicy: Local
  allowSnippetAnnotations: true # this is a private cluster, so we can use this

  config:
    use-http2: "true"
    # enable-real-ip: "true"
    # proxy-real-ip-cidr: "10.0.0.0/16"
    use-proxy-protocol: "true"
    # https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#block-user-agents
    block-user-agents: "~*^meta-externalagent.*"
    # flag the sign up URLs from countries that only produce spam
    http-snippet: |
      map $geoip2_country_code $is_spammy_country {
        default 0;
        VN 1;
        IN 1;
        PH 1;
      }

      map "$request_method $uri" $is_signup_url {
        default 0;
        "POST /api/v1/accounts" 1;
        "GET /auth/sign_up"     1;
        "POST /auth"            1;
      }

  extraEnvs:
    - name: MAXMIND_LICENSE_KEY
      valueFrom:
        secretKeyRef:
          name: maxmind-license-key
          key: license

  extraArgs:
    maxmind-license-key: $(MAXMIND_LICENSE_KEY)
    enable-ssl-passthrough: ""

  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
    prometheusRule:
      enabled: true
      rules:
        - alert: NGINXConfigFailed
          expr:
            count(nginx_ingress_controller_config_last_reload_successful == 0) >
            0
          for: 1s
          labels:
            severity: critical
          annotations:
            description: bad ingress config - nginx config test failed
            summary:
              uninstall the latest ingress changes to allow config reloads to
              resume
        - alert: NGINXTooMany500s
          expr:
            100 * ( sum( nginx_ingress_controller_requests{status=~"5.+"} ) /
            sum(nginx_ingress_controller_requests) ) > 5
          for: 1m
          labels:
            severity: warning
          annotations:
            description: Too many 5XXs
            summary:
              More than 5% of all requests returned 5XX, this requires your
              attention
        - alert: NGINXTooMany400s
          expr:
            100 * ( sum( nginx_ingress_controller_requests{status=~"4.+"} ) /
            sum(nginx_ingress_controller_requests) ) > 5
          for: 1m
          labels:
            severity: warning
          annotations:
            description: Too many 4XXs
            summary:
              More than 5% of all requests returned 4XX, this requires your
              attention

  ingressClassResource:
    default: true

  resources:
    requests:
      cpu: 256m
      memory: 956Mi
    limits:
      memory: 956Mi
