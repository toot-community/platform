apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: &namespace microblog-network

helmGlobals:
  chartHome: ../../../../../charts
  
resources:
  - ../../base
  - secrets.yaml

helmCharts:
  - name: redis
    version: "21.1.3"
    releaseName: redis
    namespace: *namespace
    valuesFile: ../../base/helm-values/redis.yaml
    additionalValuesFiles:
      - helm-values/redis.yaml
    repo: oci://registry-1.docker.io/bitnamicharts
  - name: haproxy
    version: "1.24.0"
    releaseName: haproxy-redis
    namespace: *namespace
    valuesFile: ../../base/helm-values/haproxy.yaml
    additionalValuesFiles:
      - helm-values/haproxy.yaml
    repo: https://haproxytech.github.io/helm-charts
  - name: mastodon
    version: "0.0.0"
    releaseName: mastodon
    namespace: *namespace
    valuesFile: ../../base/helm-values/mastodon.yaml
    additionalValuesFiles:
      - helm-values/mastodon.yaml
  
images:
  - name: ghcr.io/mastodon/mastodon
    newTag: "v4.3.8@sha256:b99679915129b9c47fb39a6f5ddeec14a062a47603ac22169d87a45a3859c89f"
  - name: ghcr.io/mastodon/mastodon-streaming
    newTag: "v4.3.8@sha256:9c258e83c69b7e6219425b1867e5851ffd53c9029e19e831bd31be8d80c5b42a"
  - name: ghcr.io/nginx/nginx-s3-gateway/nginx-oss-s3-gateway
    newTag: "unprivileged-oss-20250519@sha256:787705b7a05ede916d700c3b8d4bb17e093c0d02326be36c23fa0282545d02b6"
    
patches:
  - path: database-cluster.yaml