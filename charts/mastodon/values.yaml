# =============================================================================
# GLOBAL SETTINGS
# =============================================================================
global:
  # Default image for all Mastodon components (web, sidekiq, jobs)
  image:
    repository: ghcr.io/mastodon/mastodon
    pullPolicy: IfNotPresent
    tag: ""  # Defaults to Chart.AppVersion if empty

  imagePullSecrets: []

  # Default pod settings inherited by all components
  podDefaults:
    annotations: {}

    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
      runAsNonRoot: true
      runAsUser: 991
      seccompProfile:
        type: RuntimeDefault

    podSecurityContext:
      fsGroup: 991
      runAsGroup: 991
      runAsUser: 991

    terminationGracePeriodSeconds: 30

# =============================================================================
# CHART METADATA
# =============================================================================
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  name: ""
  annotations: {}

# =============================================================================
# APPLICATION CONFIGURATION
# =============================================================================
mastodon:
  # Instance domain settings
  localDomain: example.com
  webDomain: ""  # Defaults to localDomain if empty

  # Localization
  defaultLocale: en

  # Federation settings
  authorizedFetch: false
  limitedFederationMode: false

  # Privacy settings
  ipRetentionPeriod: 31556952      # 1 year in seconds
  sessionRetentionPeriod: 31556952  # 1 year in seconds

  # Network settings
  trustedProxyIp: "10.244.0.0/16"
  allowedPrivateAddresses: ""  # e.g., 10.0.8.0/21 for ES service subnet

  # Extra environment variables (key-value pairs)
  extraEnv: {}

# =============================================================================
# DATABASE CONFIGURATION
# =============================================================================
database:
  # Primary database connection (through pooler)
  primary:
    host: database-pooler-rw
    port: 5432
    name: app
    poolSize: 25
    sslMode: require

  # Read replica for read-heavy workloads (used by streaming if enabled)
  replica:
    enabled: false
    host: database-pooler-ro
    port: 5432

  # Direct connection for migrations (bypasses pgbouncer)
  migrations:
    host: database-rw
    port: 5432
    name: app
    runOnUpgrade: true

  # Credentials from Kubernetes secret
  credentials:
    secretName: database-app
    usernameKey: username
    passwordKey: password

# =============================================================================
# REDIS CONFIGURATION
# =============================================================================
redis:
  host: redis-ha-haproxy
  port: 6379
  database: 0
  url: ""  # Full URL format (takes precedence if set, used by streaming)

# =============================================================================
# OBJECT STORAGE (S3)
# =============================================================================
s3:
  bucket: ""  # REQUIRED: S3 bucket name
  region: ""  # REQUIRED: S3 region
  endpoint: ""  # REQUIRED: S3 endpoint URL
  hostname: ""  # REQUIRED: S3 hostname
  protocol: https
  aliasHost: ""  # REQUIRED: CDN/alias hostname for static assets
  multipartThreshold: "1024000000"  # 1GB (essentially disabling multipart uploads)
  timeouts:
    open: 10
    read: 10

# =============================================================================
# EMAIL (SMTP)
# =============================================================================
smtp:
  server: ""  # REQUIRED: SMTP server hostname
  port: 465
  domain: ""  # REQUIRED: Domain for SMTP HELO
  fromAddress: ""  # REQUIRED: From address for outgoing emails
  authMethod: plain
  deliveryMethod: smtp
  enableStarttlsAuto: true
  opensslVerifyMode: peer
  caFile: /etc/ssl/certs/ca-certificates.crt

# =============================================================================
# SEARCH (ELASTICSEARCH)
# =============================================================================
search:
  enabled: false
  host: elasticsearch-es-http
  port: 9200
  scheme: http
  user: elastic
  preset: single_node_cluster  # https://github.com/mastodon/documentation/pull/1279/files
  password:
    secretKeyRef:
      name: elasticsearch-es-elastic-user
      key: elastic

# =============================================================================
# TRANSLATIONS
# =============================================================================
translations:
  enabled: true
  libretranslate:
    enabled: true
    endpoint: https://translate.mstdn.social/
  deepl:
    enabled: false
    plan: free

# =============================================================================
# OBSERVABILITY
# =============================================================================
observability:
  # OpenTelemetry tracing
  otel:
    enabled: false
    namePrefix: mastodon
    nameSeparator: "/"
    exporterUri: http://otel-collector:4317

  # Prometheus metrics
  metrics:
    enabled: true
    port: 9394

    # Web component metrics
    web:
      detailed: true
      exporter:
        resources:
          requests:
            cpu: 100m
            memory: 180Mi
          limits:
            memory: 250Mi

    # Sidekiq metrics
    sidekiq:
      detailed: true

    # PodMonitor configuration (shared across components)
    podMonitor:
      enabled: true
      interval: 30s
      scrapeTimeout: 10s
      path: /metrics
      scheme: http

# =============================================================================
# COMPONENT: WEB
# =============================================================================
web:
  replicas: 2
  port: 3000

  # Puma configuration
  concurrency: 2
  maxThreads: 5

  # Image override (inherits from global.image if not set)
  image: {}

  resources:
    requests:
      cpu: 275m
      memory: 1045Mi
    limits:
      memory: 1045Mi

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 0%

  podDisruptionBudget:
    enabled: true
    minAvailable: 2

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: web
            topologyKey: kubernetes.io/hostname

  nodeSelector: {}
  tolerations: []

  startupProbe:
    httpGet:
      port: http
      path: /health
    periodSeconds: 3
    failureThreshold: 30

  readinessProbe:
    httpGet:
      path: /health
      port: http
      scheme: HTTP
    periodSeconds: 10
    successThreshold: 1
    failureThreshold: 3
    timeoutSeconds: 10

  livenessProbe:
    httpGet:
      path: /health
      port: http
      scheme: HTTP
    initialDelaySeconds: 120
    periodSeconds: 15
    failureThreshold: 3
    timeoutSeconds: 5

  annotations: {}

  # KEDA autoscaling based on Puma thread utilization metrics.
  # Requires observability.metrics.enabled and observability.metrics.podMonitor.enabled.
  autoscaling:
    keda:
      enabled: false
      pollingInterval: 30
      cooldownPeriod: 300
      minReplicaCount: null
      maxReplicaCount: 10
      fallback:
        enabled: true
        failureThreshold: 3
        replicas: null
      advanced:
        horizontalPodAutoscalerConfig:
          behavior:
            scaleUp:
              stabilizationWindowSeconds: 0
              policies:
                - type: Percent
                  value: 200
                  periodSeconds: 60
                - type: Pods
                  value: 4
                  periodSeconds: 60
              selectPolicy: Max
            scaleDown:
              stabilizationWindowSeconds: 600
              policies:
                - type: Percent
                  value: 10
                  periodSeconds: 60
                - type: Pods
                  value: 1
                  periodSeconds: 60
              selectPolicy: Min
      prometheus:
        serverAddress: http://vmsingle-vm.victoriametrics.svc.cluster.local:8428
        threshold: "0.6"
        activationThreshold: "0.4"
        metricType: AverageValue
        query: "" # Leave empty to use the default raw Puma busy-fraction query.

# =============================================================================
# COMPONENT: STREAMING
# =============================================================================
streaming:
  replicas: 2
  port: 4000
  clusterNum: 1

  # Base URL for WebSocket connections
  baseUrl: ""  # REQUIRED: e.g., wss://streaming.example.com

  # Streaming has its own image (Node.js)
  image:
    repository: ghcr.io/mastodon/mastodon-streaming
    pullPolicy: IfNotPresent
    tag: v4.5.5@sha256:de54305f02618c46f74b155ae73d65913a64f288b1d462f357a758f91741884b

  # Override database SSL mode for streaming
  databaseSslMode: no-verify

  resources:
    requests:
      cpu: 41m
      memory: 100Mi
    limits:
      memory: 100Mi

  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%

  podDisruptionBudget:
    enabled: true
    minAvailable: 1

  affinity:
    podAntiAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchLabels:
                app.kubernetes.io/component: streaming
            topologyKey: kubernetes.io/hostname

  nodeSelector: {}
  tolerations: []

  startupProbe:
    httpGet:
      port: streaming
      path: /api/v1/streaming/health
    periodSeconds: 3
    failureThreshold: 30

  readinessProbe:
    httpGet:
      path: /api/v1/streaming/health
      port: streaming
      scheme: HTTP
    periodSeconds: 10
    successThreshold: 1
    failureThreshold: 3
    timeoutSeconds: 10

  livenessProbe:
    httpGet:
      path: /api/v1/streaming/health
      port: streaming
      scheme: HTTP
    initialDelaySeconds: 120
    periodSeconds: 15
    failureThreshold: 3
    timeoutSeconds: 5

  # Streaming-specific PodMonitor override
  podMonitor:
    port: streaming

  annotations: {}

# =============================================================================
# COMPONENT: SIDEKIQ
# =============================================================================
sidekiq:
  # Default settings for all workers
  defaults:
    resources:
      requests:
        cpu: 125m
        memory: 541Mi
      limits:
        memory: 541Mi

    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 25%
        maxUnavailable: 25%

  podDisruptionBudget:
    enabled: true
    minAvailable: 1

  # Pod anti-affinity to spread workers of the same type across nodes
  # Each worker type (e.g., sidekiq-generic) avoids other pods of the same type
  affinity:
    enabled: true
    topologyKey: kubernetes.io/hostname

  nodeSelector: {}
  tolerations: []

  workers:
    - name: generic
      replicas: 3
      concurrency: 25
      queues:
        - default
        - mailers
        - ingress
        - push
        - pull
        - fasp
      resources:
        requests:
          cpu: 125m
          memory: 541Mi
        limits:
          memory: 541Mi

    - name: scheduler
      replicas: 1
      concurrency: 25
      queues:
        - scheduler
      resources:
        requests:
          cpu: 144m
          memory: 437Mi
        limits:
          memory: 437Mi

# =============================================================================
# INGRESS (NGINX INGRESS CONTROLLER)
# =============================================================================
ingress:
  web:
    enabled: false
    ingressClassName: nginx
    host: ""  # REQUIRED when enabled: your domain

    # Service routing override (for cache layers like Varnish)
    serviceOverride:
      name: null
      port: null

    # Nginx-specific settings
    maxBodySize: 100m
    proxyTimeout: 120

    # Client certificate verification
    verifyClient:
      enabled: false
      secretName: ""

    # WWW to non-WWW redirect
    wwwRedirect:
      enabled: true

    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    tls: []  # Configure TLS when enabled

  streaming:
    enabled: false
    ingressClassName: nginx
    host: ""  # REQUIRED when enabled: streaming domain

    annotations:
      cert-manager.io/cluster-issuer: letsencrypt
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    tls: []  # Configure TLS when enabled

# =============================================================================
# GATEWAY API
# =============================================================================
gateway:
  enabled: false

  # Default parent refs for all routes
  parentRefs: []

  web:
    hostname: ""  # Defaults to ingress.web.host
    parentRefs: []  # Overrides gateway.parentRefs
    annotations: {}

    wwwRedirect:
      enabled: false
      hostname: ""  # Defaults to www.{hostname}
      annotations: {}

  streaming:
    hostname: ""  # Defaults to ingress.streaming.host
    parentRefs: []
    annotations: {}

# =============================================================================
# SCHEDULED JOBS (CRONJOBS)
# =============================================================================
jobs:
  # Default resources for all jobs
  defaults:
    resources:
      requests:
        cpu: 250m
        memory: 500Mi
      limits:
        memory: 750Mi

  annotations: {}

  cleanupMedia:
    enabled: true
    schedule: "0 5 * * *"  # Every day at 5am
    days: 7
    resources:
      requests:
        cpu: 250m
        memory: 750Mi
      limits:
        memory: 750Mi

  cleanupMediaProfiles:
    enabled: true
    schedule: "0 5 * * *"  # Every day at 5am
    days: 14
    resources:
      requests:
        cpu: 1000m
        memory: 721Mi
      limits:
        memory: 721Mi

  removePreviewCards:
    enabled: true
    schedule: "0 5 * * 1"  # Every Monday at 5am
    days: 30
    resources:
      requests:
        cpu: 500m
        memory: 400Mi
      limits:
        memory: 400Mi

  statusesRemove:
    enabled: false
    schedule: "5 4 * * 6"  # Saturday at 4:05am
    days: 90
    resources:
      requests:
        cpu: 300m
        memory: 1500Mi
      limits:
        memory: 1500Mi

  accountsPrune:
    enabled: false
    schedule: "0 2 * * 1"  # Every Monday at 2am
    resources:
      requests:
        cpu: 1033m
        memory: 584Mi
      limits:
        memory: 584Mi

# =============================================================================
# DEBUG MODE
# =============================================================================
debug:
  enabled: false
