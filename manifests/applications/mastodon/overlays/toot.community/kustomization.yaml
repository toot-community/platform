apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: &namespace toot-community

helmGlobals:
  chartHome: ../../../../../charts
  
resources:
  - ../../base
  - ../../base/search-cluster.yaml
  - secrets.yaml
  - database-rw-pooler.yaml

helmCharts:
  - name: redis-ha
    valuesFile: ../../base/helm-values/redis-ha.yaml
    additionalValuesFiles:
      - helm-values/redis-ha.yaml
    releaseName: redis-ha
    version: 4.35.5
    namespace: *namespace
    repo: https://dandydeveloper.github.io/charts
  - name: mastodon
    version: "0.0.0"
    releaseName: mastodon
    namespace: *namespace
    valuesFile: ../../base/helm-values/mastodon.yaml
    additionalValuesFiles:
      - helm-values/mastodon.yaml
  - name: varnish
    version: "0.0.0"
    releaseName: varnish-for-app
    namespace: *namespace
    valuesFile: ../../base/helm-values/varnish-for-app.yaml
    additionalValuesFiles:
      - helm-values/varnish-for-app.yaml
  - name: varnish
    version: "0.0.0"
    releaseName: varnish-for-static
    namespace: *namespace
    valuesFile: ../../base/helm-values/varnish-for-static.yaml
    additionalValuesFiles:
      - helm-values/varnish-for-static.yaml

images:
  - name: ghcr.io/mastodon/mastodon
    newTag: "v4.5.4@sha256:16def7e8dec489a487694e00a6e360beee73ae883c312a683df81c490564495f"
  - name: ghcr.io/mastodon/mastodon-streaming
    newTag: "v4.5.4@sha256:efb648430e28fc2be14ed1292351e3ca34461d6eef68cfb347b4788b8be31737"
  - name: varnish
    newTag: "8.0.0@sha256:aaf3ba9a2335fa9b2f7b0b222a07db46be12269f7319192caa299f724d705199"
 
patches:
  - path: database-cluster.yaml
  - target:
      name: elasticsearch
      kind: Elasticsearch
    patch: |-
      - op: replace
        path: /spec/nodeSets/0/podTemplate/spec/containers/0/resources
        value: 
          requests:
            cpu: '300m'
            memory: 4Gi
          limits:
            memory: 4Gi
      - op: replace
        path: /spec/nodeSets/0/volumeClaimTemplates/0/spec/resources/requests/storage
        value: 40Gi