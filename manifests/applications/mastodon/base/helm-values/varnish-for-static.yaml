onload: 
  host: haproxy-onload.haproxy-onload.svc.cluster.local
  port: 8080
  
varnish:
  size: 256M
  configuration: |
    |-
    vcl 4.1;
    
    # https://github.com/varnish/toolbox/tree/master/vcls/hit-miss
    include "hit-miss.vcl";
    import dynamic;
    
    backend proxy {
      .host = "{{ .Values.onload.host }}";
      .port = "{{ .Values.onload.port }}";
    }

    # backend default {
    #   .host = "{{ .Values.backend.host }}";
    #   .port = "{{ .Values.backend.port }}";
    #   .via = proxy;
    # }
    
    sub vcl_init {
        new d = dynamic.director(
            port = "{{ .Values.backend.port }}",
            ttl = 30s
            via = proxy
        );
    }
    
    sub vcl_backend_fetch {
      set bereq.http.Host = "{{ .Values.backend.host }}";
    }
    
    sub vcl_deliver {
      unset resp.http.x-amz-request-id;
      unset resp.http.x-debug-bucket;
      unset resp.http.x-rgw-object-type;
    }
    
    sub vcl_recv {
      set req.backend_hint = d.backend("{{ .Values.backend.host }}");
      
      if (req.url == "/__health") {
          return (synth(200, "OK"));
      }
    }

    sub vcl_synth {
        if (resp.status == 200 && req.url == "/__health") {
            set resp.http.Content-Type = "text/plain";
            set resp.body = "Varnish is healthy\n";
            return (deliver);
        }
    }