name: OpenTofu Plan

on:
  push:
    branches: [task/opentofu-gh-action]
    paths:
      - 'platform/**'
      - '.github/workflows/tofu-plan.yml'

env:
  WORKING_DIR: platform

jobs:
  plan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: 1.10.2
      
      - name: Initialize OpenTofu
        run: tofu init
        working-directory: ${{ env.WORKING_DIR }}
        env:
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      
      - name: Generate plan
        id: plan
        run: |
          tofu plan -no-color -var-file=./configs/production.tfvars -out=plan.tfplan
          tofu show -no-color plan.tfplan > plan.txt
        working-directory: ${{ env.WORKING_DIR }}
        env:
          hcloud_token: ${{ secrets.HCLOUD_TOKEN }}
          AWS_ACCESS_KEY_ID: ${{ secrets.S3_ACCESS_KEY }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.S3_SECRET_KEY }}
      
      - name: Create PR with plan
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: OpenTofu plan for ${{ github.sha }}"
          title: "OpenTofu Plan - ${{ github.sha }}"
          body: |
            ## OpenTofu Plan
            
            This PR contains the OpenTofu plan for the changes in commit ${{ github.sha }}.
            
            ### Plan Output
            
            ```
            ${{ steps.plan.outputs.stdout }}
            ```
            
            **Important**: Review the plan carefully before merging. Merging this PR will trigger the deployment.
          branch: tofu-plan-${{ github.sha }}
          delete-branch: true
          draft: false