apiVersion: apps/v1
kind: Deployment
metadata:
  name: oidc-proxy
  namespace: oidc-issuer
  labels:
    app.kubernetes.io/instance: oidc-proxy
    app.kubernetes.io/name: oidc-proxy
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/instance: oidc-proxy
      app.kubernetes.io/name: oidc-proxy
  template:
    metadata:
      labels:
        app.kubernetes.io/instance: oidc-proxy
        app.kubernetes.io/name: oidc-proxy
    spec:
      serviceAccountName: oidc-proxy
      automountServiceAccountToken: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 101
        runAsGroup: 101
        fsGroup: 101
        seccompProfile:
          type: RuntimeDefault
      initContainers:
      - name: oidc-fetch
        image: curlimages/curl:8.10.1
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        args:
        - |-
          set -eu
          mkdir -p /data/.well-known /data/openid/v1
          API_HOST="${KUBERNETES_SERVICE_HOST:-kubernetes.default.svc}"
          API_PORT="${KUBERNETES_SERVICE_PORT_HTTPS:-${KUBERNETES_SERVICE_PORT:-443}}"
          BASE_URL="https://kubernetes.default.svc:${API_PORT}"
          RESOLVE_OPT="--resolve kubernetes.default.svc:${API_PORT}:${API_HOST}"
          TOKEN="$(cat /var/run/secrets/oidc/token)"
          curl -fsS --cacert /etc/ssl/certs/kube-ca.crt \
            ${RESOLVE_OPT} \
            -H "Authorization: Bearer ${TOKEN}" \
            ${BASE_URL}/.well-known/openid-configuration \
            -o /data/.well-known/openid-configuration
          curl -fsS --cacert /etc/ssl/certs/kube-ca.crt \
            ${RESOLVE_OPT} \
            -H "Authorization: Bearer ${TOKEN}" \
            ${BASE_URL}/openid/v1/jwks \
            -o /data/openid/v1/jwks
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        volumeMounts:
        - name: oidc-data
          mountPath: /data
        - name: oidc-proxy-token
          mountPath: /var/run/secrets/oidc
          readOnly: true
        - name: kube-root-ca
          mountPath: /etc/ssl/certs/kube-ca.crt
          subPath: ca.crt
          readOnly: true
      containers:
      - name: oidc-proxy
        image: nginxinc/nginx-unprivileged:1.27.1-alpine
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 8080
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        readinessProbe:
          httpGet:
            path: /.well-known/openid-configuration
            port: http
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3
        livenessProbe:
          httpGet:
            path: /openid/v1/jwks
            port: http
          periodSeconds: 10
          timeoutSeconds: 2
          failureThreshold: 3
        volumeMounts:
        - name: config
          mountPath: /etc/nginx/conf.d/default.conf
          subPath: default.conf
          readOnly: true
        - name: oidc-data
          mountPath: /usr/share/nginx/html
          readOnly: true
        - name: nginx-cache
          mountPath: /var/cache/nginx
        - name: nginx-run
          mountPath: /var/run
        - name: tmp
          mountPath: /tmp
      - name: oidc-refresh
        image: curlimages/curl:8.10.1
        imagePullPolicy: IfNotPresent
        command:
        - /bin/sh
        - -c
        args:
        - |-
          set -eu
          while true; do
            API_HOST="${KUBERNETES_SERVICE_HOST:-kubernetes.default.svc}"
            API_PORT="${KUBERNETES_SERVICE_PORT_HTTPS:-${KUBERNETES_SERVICE_PORT:-443}}"
            BASE_URL="https://kubernetes.default.svc:${API_PORT}"
            RESOLVE_OPT="--resolve kubernetes.default.svc:${API_PORT}:${API_HOST}"
            TOKEN="$(cat /var/run/secrets/oidc/token)"
            curl -fsS --cacert /etc/ssl/certs/kube-ca.crt \
              ${RESOLVE_OPT} \
              -H "Authorization: Bearer ${TOKEN}" \
              ${BASE_URL}/.well-known/openid-configuration \
              -o /data/.well-known/openid-configuration.tmp
            mv /data/.well-known/openid-configuration.tmp /data/.well-known/openid-configuration
            curl -fsS --cacert /etc/ssl/certs/kube-ca.crt \
              ${RESOLVE_OPT} \
              -H "Authorization: Bearer ${TOKEN}" \
              ${BASE_URL}/openid/v1/jwks \
              -o /data/openid/v1/jwks.tmp
            mv /data/openid/v1/jwks.tmp /data/openid/v1/jwks
            sleep 300
          done
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        volumeMounts:
        - name: oidc-data
          mountPath: /data
        - name: oidc-proxy-token
          mountPath: /var/run/secrets/oidc
          readOnly: true
        - name: kube-root-ca
          mountPath: /etc/ssl/certs/kube-ca.crt
          subPath: ca.crt
          readOnly: true
      volumes:
      - name: config
        configMap:
          name: oidc-proxy-config
      - name: oidc-data
        emptyDir: {}
      - name: oidc-proxy-token
        projected:
          sources:
            - serviceAccountToken:
                expirationSeconds: 600
                path: token
      - name: kube-root-ca
        configMap:
          name: kube-root-ca.crt
      - name: nginx-cache
        emptyDir: {}
      - name: nginx-run
        emptyDir: {}
      - name: tmp
        emptyDir: {}
