apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: &namespace microblog-network

helmGlobals:
  chartHome: ../../../../../charts
  
resources:
  - ../../base
  - secrets.yaml
helmCharts:
  - name: redis-ha
    valuesFile: ../../base/helm-values/redis-ha.yaml
    additionalValuesFiles:
      - helm-values/redis-ha.yaml
    releaseName: redis-ha
    version: 4.35.5
    namespace: *namespace
    repo: https://dandydeveloper.github.io/charts
  - name: mastodon
    version: "0.0.0"
    releaseName: mastodon
    namespace: *namespace
    valuesFile: ../../base/helm-values/mastodon.yaml
    additionalValuesFiles:
      - helm-values/mastodon.yaml
  - name: varnish
    version: "0.0.0"
    releaseName: varnish-for-static
    namespace: *namespace
    valuesFile: ../../base/helm-values/varnish-for-static.yaml
    additionalValuesFiles:
      - helm-values/varnish-for-static.yaml
  - name: varnish
    version: "0.0.0"
    releaseName: varnish-for-app
    namespace: *namespace
    valuesFile: ../../base/helm-values/varnish-for-app.yaml
    additionalValuesFiles:
      - helm-values/varnish-for-app.yaml

images:
  - name: ghcr.io/mastodon/mastodon
    newTag: "v4.5.5@sha256:ad853d269aa4be95c7d4e5fedf7e71679494614d445c0e3dace0e12d3d93aebc"
  - name: ghcr.io/mastodon/mastodon-streaming
    newTag: "v4.5.5@sha256:de54305f02618c46f74b155ae73d65913a64f288b1d462f357a758f91741884b"
  - name: varnish
    newTag: "8.0.0@sha256:4cb22000290f981492b3228622276c8ebfc57788c86e331bb96fbe55461a53e3"
    
patches:
  - path: database-cluster.yaml
  - path: ../../base/patches/redis-ha-haproxy-affinity.yaml
