container_runtime: containerd

agent:
  resources:
    limits:
      memory: "1Gi"
    requests:
      cpu: "500m"
      memory: "500Mi"
  acquisition:
    - namespace: traefik-system
      podName: traefik-*
      program: traefik
      poll_without_inotify: true
  env:
    - name: COLLECTIONS
      value: "crowdsecurity/traefik"
    - name: DISABLE_SCENARIOS
      value: |
        crowdsecurity/http-crawl-non_statics
        crowdsecurity/http-generic-bf
        crowdsecurity/http-probing

lapi:
  replicas: 2
  storeCAPICredentialsInSecret: true
  strategy:
    type: RollingUpdate
  resources:
    limits:
      cpu: "250m"
      memory: "256Mi"
    requests:
      cpu: "50m"
      memory: "128Mi"
  persistentVolume:
    config:
      enabled: false
    data:
      enabled: false
  env:
    - name: ENROLL_KEY
      valueFrom:
        secretKeyRef:
          name: crowdsec-secrets
          key: ENROLL_KEY
    - name: ENROLL_INSTANCE_NAME
      value: "toot-community"
    - name: ENROLL_TAGS
      value: "k8s linux"
    - name: DB_PASSWORD
      valueFrom:
        secretKeyRef:
          name: crowdsec-db-app
          key: password
    - name: DB_USER
      valueFrom:
        secretKeyRef:
          name: crowdsec-db-app
          key: username
    - name: DB_NAME
      valueFrom:
        secretKeyRef:
          name: crowdsec-db-app
          key: dbname
    - name: DB_HOST
      valueFrom:
        secretKeyRef:
          name: crowdsec-db-app
          key: host
    - name: DB_PORT
      valueFrom:
        secretKeyRef:
          name: crowdsec-db-app
          key: port
    - name: DB_SSLMODE
      value: "require"
    - name: BOUNCER_KEY_traefik
      valueFrom:
        secretKeyRef:
          name: crowdsec-secrets
          key: BOUNCER_KEY_traefik

appsec:
  enabled: true
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 0
      maxSurge: 1
  acquisitions:
    - source: appsec
      listen_addr: 0.0.0.0:7422
      path: /
      appsec_configs:
        - crowdsecurity/appsec-default
        - toot-community/media-proxy-srcset-abuse-inband
      labels:
        type: appsec
  env:
    - name: COLLECTIONS
      value: "crowdsecurity/appsec-virtual-patching crowdsecurity/appsec-generic-rules"
  configs:
    media-proxy-srcset-abuse-inband.yaml: |
      name: toot-community/media-proxy-srcset-abuse-inband
      default_remediation: ban
      inband_rules:
        - toot-community/media-proxy-srcset-abuse
  rules:
    media-proxy-srcset-abuse.yaml: |
      name: toot-community/media-proxy-srcset-abuse
      description: "Block malformed Mastodon /media_proxy requests that look like srcset values being fetched as URLs"
      rules:
        - and:
            - zones:
                - METHOD
              match:
                type: equals
                value: GET
            - zones:
                - URI
              match:
                type: startsWith
                value: /media_proxy/
            - or:
                - zones:
                    - URI
                  match:
                    type: contains
                    value: ",%20https:"
                - zones:
                    - URI
                  match:
                    type: contains
                    value: "%2C%20https:"
                - zones:
                    - URI
                  match:
                    type: contains
                    value: ", https:"
                - zones:
                    - URI
                  match:
                    type: contains
                    value: "%2C https:"

config:
  profiles.yaml: |
    name: tencent_scraper_profile
    filters:
      - Alert.Remediation == true && Alert.GetScenario() == "toot-community/tencent-scraper"
    decisions:
      - type: ban
        duration: 2160h
    on_success: break
    ---
    name: mastodon_media_proxy_srcset_abuse_profile
    filters:
      - Alert.Remediation == true && Alert.GetScenario() == "toot-community/media-proxy-srcset-abuse"
    decisions:
      - type: ban
        duration: 2160h
    on_success: break
    ---
    name: default_ip_remediation
    filters:
      - Alert.Remediation == true && Alert.GetScope() == "Ip"
    decisions:
      - type: ban
        duration: 4h
    on_success: break
  scenarios:
    tencent-scraper.yaml: |
      type: trigger
      name: toot-community/tencent-scraper
      description: "Detect Tencent scraper based on User-Agent fingerprint and ASN"
      filter: |
        evt.Meta.log_type == "http_access-log" &&
        evt.Meta.http_user_agent contains "Chrome/126.0.6478.114" &&
        evt.Meta.http_user_agent contains "Windows NT 6.1" &&
        evt.Meta.ASNNumber in ["132203", "132591", "45090"]
      groupby: evt.Meta.source_ip
      blackhole: 5m
      labels:
        service: http
        type: scraper
        remediation: true
    media-proxy-srcset-abuse.yaml: |
      type: trigger
      name: toot-community/media-proxy-srcset-abuse
      description: "Detect malformed Mastodon /media_proxy requests that look like srcset values being fetched as URLs"
      filter: |
        evt.Meta.log_type == "http_access-log" &&
        evt.Meta.http_verb == "GET" &&
        evt.Meta.http_path startsWith "/media_proxy/" &&
        evt.Meta.http_path contains "%20" &&
        (
          evt.Meta.http_path contains ",%20https:/" ||
          evt.Meta.http_path contains "%2C%20https:/"
        )
      groupby: evt.Meta.source_ip
      blackhole: 30m
      labels:
        service: http
        type: scraper
        remediation: true
  config.yaml.local: |
    db_config:
      type:     postgres
      user:     ${DB_USER}
      password: ${DB_PASSWORD}
      db_name:  ${DB_NAME}
      host:     ${DB_HOST}
      port:     ${DB_PORT}
      sslmode:  ${DB_SSLMODE}
      flush:
        max_age: 7d
        metrics_max_age: 90d
        bouncers_autodelete:
          cert: 60m
          api_key: 60m
        agents_autodelete:
          cert: 60m
          login_password: 60m
    api:
      server:
        auto_registration:
          enabled: true
          token: "${REGISTRATION_TOKEN}"
          allowed_ranges:
            - "10.0.0.0/8"
